# 🚀 Project Z-Tide（尸潮）开发计划迭代版白皮书 v1

目标：基于现有仓库的工程能力与资产积累，完成一次“方向转向 + 架构升级”，在 Web 端稳定实现 **3000+ 流体尸潮同屏**（Hook），并用 **合成经营** 构建可持续的核心循环（Loop）。

本文档用于后续开发的“单一真相来源”（Single Source of Truth）：按阶段定义范围、交付物、验收标准、风险与性能红线。

---

## 0. 当前进度（代码同步）

更新时间：2025-12-28

- `M0（Week 1）`：已完成（Z-Tide 入口 + Pixi/React 双层骨架 + 性能 HUD）
- `M1（Week 2）`：已完成（Flow Field：Integration/Vector + 热力/箭头 Debug + 墙体编辑实时重算）
- `M2（Week 3）`：已完成（Swarm：SoA + 空间分桶 + 分离力；支持 3000+ 同屏，已转 ParticleContainer 批渲染）
- `M3（Week 4）`：已完成（密度阈值溢出/压力推挤 + 运行时调参：ρ/P）
- `M4（Week 5）`：进行中（基地 HP + 波次按钮 + 机枪塔自动索敌/击杀 + 金币）

## 1. 项目定位与验收口径（对齐制作人目标）

- **产品定位**：Hybrid SLG = “流体塔防 Roguelite（吸量）” + “合成经营/地块扩张（留存与变现）”
- **核心卖点（素材级）**：尸潮像黑水一样绕障、堆叠、漫灌、被引流；画面密度足够高，手机浏览器也不崩
- **Phase 1 成败标准**（必须先跑通）
  - 视觉：同屏 3000+ 单位“有流体感”，能明显看出尸潮被墙/通道引导
  - 交互：放置障碍物立即改变潮流走向；至少 1 种塔能稳定清怪
  - 性能：稳定 60fps（桌面）/ 40fps（中端移动设备）为最低线；掉帧可解释且可调参缓解

### 1.1 终端标准（中端安卓 + H5）

本白皮书的默认验收设备为“中端安卓 + H5 浏览器”，以避免开发期在高端机“虚假达标”。

- **浏览器基线**：Android Chrome（近两年版本区间），WebGL2 可用；触控为主，横竖屏自适应
- **硬件基线**：6GB 内存级别；中端 SoC（非旗舰）常见机型档位
- **帧率口径**：目标 60fps；验收线 40fps（持续 10 分钟运行，含波次与交互）
- **性能口径**：Script Time < 12ms（移动端）；DrawCall < 100（目标 < 50）；避免长 GC 停顿导致可感知卡顿
- **降级原则**：一切“降级开关”必须能在运行时切换并可被记录（便于做设备分档）

---

## 2. 现有仓库现状盘点（基于当前目录与代码）

### 2.1 当前项目是什么

当前仓库实际是一套可运行的 Web Demo：`Zombie Crisis: OSM Operations`（真实地图 + 实体仿真 + AI 通讯）。

- **技术栈**：Vite + React 19 + TypeScript；地图渲染为 `Leaflet/react-leaflet`；AI 为 `@google/genai`
- **UI**：在 `index.html` 通过 CDN 引入 Tailwind（非 npm 依赖）
- **核心循环形态**：不是网格塔防，而是基于经纬度坐标的“真实世界战场管理”

### 2.2 目录结构（关键文件）

- `App.tsx`：管理 UI 与地图层的状态、暂停/重开、日志（核心入口）
- `components/GameMap.tsx`：地图容器 + 绝大多数仿真逻辑（实体生成、移动、战斗、效果、音频触发）
- `components/UIOverlay.tsx`：HUD 与交互面板（工具、建筑分析、日志等）
- `services/audioService.ts`：较完整的 BGM/SFX 系统（可复用价值高）
- `services/mapDataService.ts`：OSM/Nominatim/Overpass 数据（与 Z-Tide 方向不一致）
- `services/geminiService.ts`：AI 文本生成（与 Z-Tide Phase 1 不相关）
- `types.ts` / `constants.ts`：面向“经纬度实体仿真”的数据结构与参数表（需重建为“网格/塔防”模型）

### 2.3 当前 Demo 的“可继承资产”与“必须切割部分”

可继承（建议复用/改造）：
- **音频系统**：`services/audioService.ts` 的节流、BGM 状态机、buffer 管理可以迁移到 Z-Tide
- **工程脚手架**：Vite + React + TS 已就绪；多语言 `i18n` 可保留
- **UI 叠加方式**：全屏容器 + 交互 HUD 的组织方式可延续

必须切割（与新方向冲突或成本过高）：
- **Leaflet/OSM 依赖链**：真实地图渲染与在线数据请求会吞噬性能/稳定性预算，不适合“万尸同屏”
- **经纬度坐标系**：Z-Tide 要求“网格 + 流场”，需要新的核心数据模型
- **巨型单文件仿真**：`GameMap.tsx` 近 2000 行，继续堆叠会阻塞后续迭代与性能优化

结论（主程视角）：
- 这是一个“功能丰富但方向不同”的 Demo。要做 Z-Tide，最优路径是 **在同一仓库并行引入新 Game Layer（Pixi/WebGL）**，再逐步让入口切到新模式；而不是在 Leaflet 逻辑上做性能修补。

---

## 3. 架构迭代策略（从现有仓库迁移到 Z-Tide）

### 3.1 双层架构（强制）

- **Game Layer（高性能）**：Pixi.js（WebGL），负责渲染与仿真主循环（TypedArray + 系统化更新）
- **UI Layer（业务与交互）**：React，负责拖拽合成、菜单、弹窗、商店、引导；通过 Store 与 Game 层同步

### 3.2 迁移策略（不炸仓库）

- 保留现有 Demo 作为 `legacy` 参考（不在 Phase 1 改它）
- 新增 Z-Tide 专用入口与目录（建议集中到 `src/`，减少根目录脚本散落）
- Phase 1 起，只做 Z-Tide 的核心闭环与性能；AI/OSM 功能全部冻结

### 3.3 性能红线（从第一天开始监控）

- Draw Calls：< 100（目标 < 50）
- Script Time：< 8ms（桌面）/ < 12ms（移动）
- 渲染策略：优先 Instancing/ParticleContainer；逻辑全量使用 TypedArray；对象池复用 Bullet/DamageText 等

---

## 4. Phase 0（1 周）：工程重组与 Z-Tide 最小骨架

目标：让“新 Game Layer”可独立启动、可热更新、可调试，为后续 Phase 1 的性能优化铺路。

交付物：
- Z-Tide 新入口（独立页面/路由皆可），能显示 Pixi 画布 + React 叠加 UI
- 基础调试面板：FPS、实体数量、DrawCall、Tick 耗时（哪怕是简陋文本）
- 约束落地：TypeScript Strict、统一坐标系（grid/world/screen 转换）

验收标准：
- 开发环境 `npm run dev` 可直接进入 Z-Tide Demo
- 画布全屏，Resize 正确，输入（鼠标/触摸）事件可用

风险控制：
- 本阶段不引入任何“玩法复杂度”，只立骨架；避免把性能坑埋到后面再挖

---

## 5. Phase 1（2–3 周）：流体尸潮引擎（Flow-Field Swarm Engine）

目标：用“流场寻路 + 局部挤压/分离”做出尸潮流体感，并稳定渲染 3000+ 单位。

### 5.1 核心数据模型（必须先定死）

- 网格：`W x H`（例如 64x64 / 96x96），以 `Uint8Array` 存地形（0=可走，255=墙）
- Integration Field：`Uint16Array`（或 `Uint32Array`），存距离/代价（墙=MAX）
- Vector Field：`Int8Array`/`Float32Array` 存方向（推荐用 8 方向编码 + 查表，减少内存与带宽）
- 单位（SoA 而非 AoS）：
  - `posX[] posY[] velX[] velY[]`（Float32Array）
  - `state[] hp[]`（Uint8/Uint16Array）

### 5.2 流场算法（关键技术壁垒）

交付物：
- Dijkstra/BFS 从基地扩散生成 Integration Field
- 从 Integration Field 派生 Vector Field（8 邻域最小值方向）
- Debug View：可切换显示矢量箭头与热力图

验收标准：
- 放置墙体后，Vector Field 立即变化且可视化正确
- 任意起点刷怪，尸潮能绕障流向基地

### 5.3 “流体感”实现（最小可用版本）

只做能撑住素材的最小集，不做过度物理：
- 基础推进：`vel += fieldVec * speed`
- 分离力（Separation）：基于空间哈希/网格桶，只计算邻近单位
- 密度控制：同格单位超阈值时，施加横向扩散（模拟压力溢出）

验收标准：
- 3000 单位持续运动 2 分钟不崩，不出现明显“抖动/原地打转”
- 墙体制造“潮汐分叉”，肉眼可读

### 5.4 渲染方案（必须可扩展）

- 先用“红点/胶囊体”占位
- 使用批渲染容器（ParticleContainer / Instanced 渲染）
- 绘制层分离：背景（静态）/单位（动态）/特效（少量）

验收标准：
- DrawCall 可控（目标 < 50）；实体数量提升时主要瓶颈应在 Script，而不是 GPU 状态切换

---

## 6. Phase 1.5（1 周）：最小塔防闭环（从 Tech Demo 到可玩 Demo）

目标：在流体尸潮上叠加“治水”玩法闭环：放墙引流 + 塔击杀 + 波次推进。

交付物：
- 基地（Base）与失败条件（被淹/血量归零）
- 1 种墙（阻挡）+ 1 种塔（机枪塔）
- 波次系统：开始一波 → 生成 → 结束判定 → 下一波
- 金币掉落/结算：击杀给金币（用于继续放墙/塔）

验收标准：
- 玩家能通过“墙体摆放”显著改变通路，并通过塔击杀守住至少 3 波
- 失败原因可解释：墙体缺口、火力不足、路线未引导

---

## 7. Phase 2（2–3 周）：合成经营（Merge Loop）+ 配置驱动

目标：把“能玩”推进到“能留存”：拖拽合成升级，数据配置化，可存档。

### 7.1 合成 UI（React 层）

交付物：
- 基地网格（2D）与建筑格子状态
- 拖拽合成规则：同类同级 → 升级；空格 → 移动；不同类 → 交换或拒绝（规则明确化）
- 合成产出与资源入口：兵营/塔/资源建筑的最小集合

验收标准：
- 连续 30 次拖拽合成无错乱；UI 与实际战斗实体一致

### 7.2 UI 与 Game 同步（数据唯一性）

强制规则：
- 业务状态只在 Store 里存在“唯一真相”
- Pixi/Game 层订阅 Store 变更，增删改实体；严禁双写

验收标准：
- 刷新页面后载入存档，UI 与战斗态一致

### 7.3 配置驱动（商业化前置）

交付物：
- 平衡表（JSON/CSV）：塔伤害、射速、墙血量、怪物 HP、波次曲线
- 版本化策略：允许快速热调（至少开发期可本地改表即生效）

验收标准：
- 调整配置无需改逻辑代码即可改变波次难度

---

## 8. Phase 3（2 周）：爽感打磨 + 最小商业化壳

目标：让 Demo 具备“可传播观感”和“可运营的最小壳”。

### 8.1 Juice（视觉/听觉反馈）

交付物：
- Screen Shake（基地受击）
- Damage Text（对象池）
- Blood Decal（RenderTexture 持久层，避免额外 DrawCall）

验收标准：
- 一眼能看出“打中了”“更危险了”“快顶不住了”

### 8.2 最小商业化组件（不接真实 SDK 也要留接口）

交付物：
- 本地存档（localStorage）
- 抽卡/英雄雏形：权重池 + 保底结构（先不做美术）
- 商店弹窗与资源入口（IAP/IAA 先做占位与埋点接口）

验收标准：
- 能完整走通：战斗→结算→回基地→合成→抽卡→再战斗

---

## 9. 质量门禁（每阶段必须做的“工程底线”）

- **可观测性**：每次性能回归必须能解释（哪个系统吃了多少 ms）
- **资源与对象池**：子弹、飘字、爆炸特效必须池化
- **输入一致性**：鼠标/触摸路径一致，且不阻塞主循环
- **可复现**：提供固定随机种子模式用于复现问题（开发期开关即可）

---

## 10. 风险清单（主程视角优先级）

- **R1：移动端性能不达标**  
  缓解：TypedArray + 8 方向编码、空间哈希、降采样（更大格子）、渲染降级档位（实体缩放/减特效）

- **R2：流体感不足（像散点而非潮水）**  
  缓解：密度阈值扩散、局部压力溢出、狭窄通道拥堵表现、调参工具化

- **R3：UI 与 Game 状态不同步**  
  缓解：单一 Store 真相 + 订阅驱动实体创建/销毁；明确“谁拥有数据”

- **R4：范围失控（SLG 复杂系统提前侵入）**  
  缓解：Phase 1 只做 Hook + 最小可玩闭环；SLG 玩法全部延后

---

## 11. 下一步工作清单（按执行顺序）

- Phase 0：把 Z-Tide 的 Pixi Game Layer 骨架落到仓库里（独立入口 + 调试面板）
- Phase 1：先做 Flow Field Debug View，再做 3000+ 单位，再做墙体引流可玩性
- Phase 1.5：把“放墙 + 塔 + 波次”闭环做出来，作为对外试玩版本

---

## 12. 周计划（建议 8 周 MVP，面向中端安卓 H5 验收）

说明：
- 本周计划用于“排期 + 每周验收 + 风险前置”，不包含“SLG 大地图/联盟/跨服”等长线系统
- 每周都必须产出“可运行可演示版本”，且在中端安卓上跑一次性能采样

### Week 1（Phase 0）：Z-Tide 骨架与性能观测落地

目标：
- Z-Tide 独立入口可启动；Game Layer 与 UI Layer 双层结构跑通；性能面板可读

交付物：
- Pixi 画布全屏 + React Overlay（基础 UI 按钮/调参开关）
- 基础输入：触控点击/拖拽事件能被 Game 层识别（先只做调试交互）
- 性能 HUD：FPS、实体数、DrawCall、Tick 耗时（至少文本输出）
- 坐标系定稿：`grid <-> world <-> screen` 转换函数与统一单位口径

里程碑验收清单：
- `M0`：中端安卓打开 H5，能进 Z-Tide 入口，持续运行 2 分钟不闪退
- `M0`：Resize/横竖屏切换不导致画面错位或输入偏移

风险预案（本周必须预埋）：
- 若 Pixi 入口集成成本过高：先独立页/独立路由隔离，避免与 legacy Leaflet 互相影响

### Week 2（Phase 1）：Flow Field v0（Integration Field + Vector Field + Debug）

目标：
- 流场算法跑通，并可视化验证正确性（这是后续所有“流体感”的基础）

交付物：
- Integration Field（距离场）生成：从基地向外扩散，墙体为不可达/极高代价
- Vector Field（方向场）生成：8 邻域选最小距离方向
- Debug View：热力图/箭头可切换；墙体编辑（画墙/擦墙）实时重算

里程碑验收清单：
- `M1`：随手画出 U 型/迷宫形墙体，方向场能正确指向出口并指向基地
- `M1`：重算耗时可观测；网格 96x96 级别重算在移动端不出现明显卡死

风险预案：
- 若全量重算抖动：引入“节流重算”（例如 100–200ms 合并多次编辑），并保留强制立即重算按钮用于调试

### Week 3（Phase 1）：Swarm v0（2000–3000 单位 + 空间哈希 + 分离力）

目标：
- 在流场上跑“群体推进”，并通过局部分离/挤压做出第一版流体感

交付物：
- 单位 SoA 数据结构（TypedArray）
- 空间哈希/网格桶（仅查附近桶计算邻居，避免 O(n^2)）
- 分离力（Separation）+ 最大速度限制 + 简单边界处理
- 刷怪器：边缘/指定点持续注入单位；支持暂停/清空/调速

里程碑验收清单：
- `M2`：中端安卓同屏 3000 单位持续运动 5 分钟不崩溃
- `M2`：在狭窄通道出现“拥堵堆叠”的可读表现（不是均匀散点）

风险预案：
- 若脚本耗时过高：优先降邻居检测半径、降低分离计算频率（隔帧/分组更新）、改 8 方向编码减少内存带宽
- 若 GC 抖动：禁止每帧创建临时对象（向量、数组），全部复用/TypedArray

### Week 4（Phase 1）：引流可玩性（墙体/通道造成明显分叉与回流）

目标：
- 把“治水”作为第一可玩点落地：玩家改地形，尸潮立刻产生路线变化

交付物：
- 墙体放置/拆除（含成本预留但可先不接经济）
- 密度阈值扩散（同格过密横向溢出），让“黑水漫灌”更明显
- 渲染批处理优化：Particle/Instanced 策略定稿；实体渲染降级档位（点/胶囊/简化阴影）

里程碑验收清单：
- `M3`：录制素材：一堵墙把尸潮分成两股并明显绕行（移动端可录屏）
- `M3`：DrawCall 受控，实体翻倍时性能下降趋势可解释（脚本或 GPU 哪个是主瓶颈）

风险预案：
- 若“流体感不足”：提高通道拥堵表现（阈值溢出 + 局部压力推挤），减少“个体自主游走”
- 若 GPU 瓶颈：降低粒子尺寸/禁用透明叠加/减少特效层，保留核心单位层

### Week 5（Phase 1.5）：最小塔防闭环（墙 + 塔 + 波次 + 失败）

目标：
- 从 Tech 变成“可玩”：玩家有目标、有反馈、有失败、有复盘空间

交付物：
- 基地（Base）血量与失败条件；基地受击反馈（至少 UI 文本）
- 机枪塔：索敌（空间哈希）+ 发射子弹（对象池）+ 扣血/击杀
- 波次系统：开始/结束；难度曲线先用配置表占位
- 金币：击杀给钱；放墙/放塔消耗（先粗糙但闭环完整）

里程碑验收清单：
- `M4`：可守住至少 3 波；失败原因清晰且可通过“摆墙/加塔”改进
- `M4`：移动端连续玩 10 分钟稳定；波次推进不出现性能持续衰退（内存泄漏）

风险预案：
- 若索敌成本高：塔索敌只在固定间隔更新（例如 100–200ms），并限制每帧处理的塔数量
- 若子弹过多：子弹改为“命中射线/瞬发”或限制同时在途子弹数量

### Week 6（Phase 2）：合成 UI v0（可拖拽、可升级、可同步）

目标：
- 合成经营成为可循环入口：塔/墙的升级从“直接放置”转为“合成升级”

交付物：
- 基地合成网格 UI（React 层）
- 合成规则落地（同类同级合并升级、移动、交换/拒绝）
- UI 与 Game 同步机制定稿（Store 单一真相；Game 订阅增删改实体）

里程碑验收清单：
- `M5`：连续 30 次拖拽合成无错乱；刷新页面后状态可恢复（先用 localStorage）

风险预案：
- 若同步抖动：合并更新为“批处理事件”（一帧内多次拖拽只触发一次 Game 重建）

### Week 7（Phase 2）：配置驱动 + 数值闭环（可快速调参）

目标：
- 调参不改代码；波次曲线、塔属性、怪物 HP 完全配置化

交付物：
- `Balance` 配置表（塔/墙/怪/波次/经济）
- Debug 面板可热更新配置（开发期；生产可关闭）
- 经济循环最小版：回合结算 → 收益 → 合成/建造 → 再开波

里程碑验收清单：
- 调整配置即可显著改变难度曲线，并能在移动端验证体验差异

风险预案：
- 若数值调参频繁导致版本混乱：配置版本号与回滚入口（至少保留最近 3 版）

### Week 8（Phase 3）：爽感打磨 + 试玩发布准备

目标：
- 形成“可传播观感”的试玩版本，并具备最小留存壳（存档/新手引导）

交付物：
- Juice：Screen Shake、Damage Text（对象池）、血迹持久层（RenderTexture）
- FTUE v0：强制引导“放塔 → 合成 → 开波”
- 质量回归：移动端 10 分钟稳定性、内存曲线、发热降频后仍可玩

里程碑验收清单：
- Demo 可对外发放（H5 链接/打包壳皆可），玩家能在 3 分钟内理解玩法并进入循环

风险预案：
- 若发热导致帧率下滑：启用降级档（减少粒子数量/降低更新频率/关闭部分特效），并记录设备档位

---

## 13. 里程碑总表（用于制作人验收与对外节点）

- `M0（Week 1）`：Z-Tide 入口 + Pixi/React 双层架构 + 性能 HUD
- `M1（Week 2）`：Flow Field 可视化可编辑（墙体影响路径）
- `M2（Week 3）`：中端安卓 3000 单位稳定运动（基础流体感）
- `M3（Week 4）`：引流素材可录（明显分叉/绕障/拥堵）
- `M4（Week 5）`：最小塔防可玩闭环（3 波可守、可失败可复盘）
- `M5（Week 6）`：合成 UI 与战斗同步 + 可存档（最小留存循环）

---

## 14. 风险预案（中端安卓 H5 专项）

### 14.1 性能风险分级与应对

- **P0（阻断级）：帧率低于 30fps 或频繁卡死**
  - 立即启用降级档：减少实体数量（例如 3000→2000）、降低分离力计算频率（隔帧/分组）、关闭透明叠加特效
  - 将 Vector Field 从 `Float32` 改为“8 方向编码 + 查表”，减少内存带宽
  - 避免任何每帧对象创建（向量/数组/闭包），所有数据转 TypedArray/对象池

- **P1（高风险）：稳定性问题（内存泄漏、运行越久越慢）**
  - 强制每波结束做一次“对象池统计 + 实体计数对账”
  - 纹理/容器生命周期收口：创建与销毁必须集中管理，避免散落到交互回调

- **P2（体验风险）：流体感不足、路线不可读**
  - 强化通道拥堵（密度阈值溢出）与墙体影响（收窄通道让分叉更明显）
  - 调参工具化：密度阈值/速度/分离半径/推挤权重必须可即时调整并保存为配置

### 14.2 H5 兼容与运行时降级策略

- **WebGL 能力检测**：启动时检测 WebGL2；若不可用则进入低配模式（更少实体、更低特效）
- **分档策略**：用运行时基准测试（1–2 秒）决定默认档位，并允许玩家手动切换
- **输入延迟控制**：触控事件必须轻量，避免在事件回调里做重计算（重计算统一进主循环）

### 14.3 研发过程控制（避免返工）

- 每周必须做一次“中端安卓实机验收”并记录：FPS、Tick 耗时、内存曲线、是否发热降频
- 任何新特效/系统进入主分支前，必须有“可关闭开关”，并纳入降级档位

